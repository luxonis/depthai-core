name: DepthAI Core HIL Stability

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v2*'
  pull_request:
    branches:
      - main
      - develop

# Only allow latest run on same branch to be tested
concurrency:
  group: ci-stability-${{ github.ref }}-1
  cancel-in-progress: true

jobs:

  # Testing
  test:
    runs-on: ['self-hosted', 'testbed-runner', 'linux']
    timeout-minutes: 1450 # 24h & 10minutes
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'
    - name: Prepare HIL Framework
      run: source scripts/hil/prepare_hil_framework.sh 

    # TODO also modify above hunter key to 'asan'
    # - name: Specify ASAN toolchain path
    #   run: echo "CMAKE_TOOLCHAIN_PATH=$PWD/cmake/toolchain/asan.cmake" >> $GITHUB_ENV

    # - name: Configure, Build and Test
    #   run: |
    #     cmake -S . -B build -D CMAKE_BUILD_TYPE=Release -D HUNTER_ROOT=$HOME/.hun_vanilla -D DEPTHAI_BUILD_TESTS=ON
    #     cmake --build build --parallel 8 --config Release --target stability_stress_test
    #     cd build
    #     ../ci/stability_stress_test_combined.sh

    # Release build
    - name: Configure, Build and Test
      run: |
        export RESERVATION_NAME="https://github.com/$GITHUB_REPOSITORY/actions/$GITHUB_RUN_ID+stability"
        exec hil --capabilities depthai-core-hil --reservation-name $RESERVATION_NAME -w -s --commands 'cd /tmp/depthai-core|| exit' 'scripts/hil/run_hil_stability.sh'
