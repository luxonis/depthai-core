name: DepthAI Core HIL Testing

on:
  workflow_dispatch:
  push:
    branches:
      - v3_develop
      - v3_docker_tests
    tags:
      - 'v*'
  pull_request:
    branches:
      - v3_develop

# Only allow latest run on same branch to be tested
concurrency:
  group: ci-tests-${{ github.ref }}-1
  cancel-in-progress: true

jobs:
  
  run_vanilla_tests:
    uses: ./.github/workflows/test_child.yml
    with:
      flavor: "vanilla"
      luxonis_os_versions_to_test: "['r851.1.2', 'debug-1.6.0', 'debug-1.11.0']"
    secrets:
      CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}
  
  run_vanilla_tsan:
    uses: ./.github/workflows/test_child.yml
    with:
      flavor: "tsan"
      luxonis_os_versions_to_test: "['debug-1.11.0']"
    secrets:
      CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}

  run_vanilla_asan-ubsan:
    uses: ./.github/workflows/test_child.yml
    with:
      flavor: "asan-ubsan"
      luxonis_os_versions_to_test: "['debug-1.11.0']"
    secrets:
      CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}

  windows_rvc2_rvc4_test:
    runs-on: ['self-hosted', 'windows', 'hil-test']
    env:
      LOCALAPPDATA: "C:/actions-runner/vcpkg_cache"
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Configure, Build and Test
      run: |
        cmake -S . -B build -D CMAKE_BUILD_TYPE=Release -D'DEPTHAI_VCPKG_INTERNAL_ONLY=OFF' -D'DEPTHAI_BUILD_EXAMPLES=ON' -D'DEPTHAI_BUILD_PYTHON=ON' -D'DEPTHAI_BUILD_TESTS=ON' -DDEPTHAI_PYTHON_ENABLE_TESTS=ON -DDEPTHAI_TEST_EXAMPLES=ON -DDEPTHAI_PYTHON_TEST_EXAMPLES=ON -DDEPTHAI_PYTHON_ENABLE_EXAMPLES=ON
        cmake --build build --parallel 4 --config Release
        cd tests
        python run_tests.py
